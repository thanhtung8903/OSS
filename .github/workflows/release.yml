name: Build and Release APK

on:
  push:
    tags:
      - 'v*'  # Trigger khi push tag version (v1.0.0, v1.1.0, etc.)
  workflow_dispatch:  # Cho phÃ©p trigger manual

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Clean project
      run: ./gradlew clean
      
    - name: Build Release APK
      run: ./gradlew assembleRelease
      
    - name: List APK files
      run: find app/build/outputs/apk -name "*.apk" -type f
      
    - name: Upload APK to Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          app/build/outputs/apk/release/*.apk
        name: OSS Shopping App ${{ github.ref_name }}
        body: |
          ## ğŸ›ï¸ OSS Shopping App Release ${{ github.ref_name }}
          
          ### âœ¨ Features:
          - ğŸ” User authentication (Login/Register)
          - ğŸ“± Product catalog with categories
          - ğŸ›’ Shopping cart functionality  
          - â¤ï¸ Wishlist management
          - ğŸ‘¤ User profile management
          - ğŸ¨ Material Design UI
          - ğŸ” Product search functionality
          - ğŸ“Š MVVM Architecture with Room Database
          
          ### ğŸ“± Installation:
          1. Download the APK file below
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK on your Android device
          
          ### ğŸ”§ Technical Requirements:
          - **Min SDK**: 27 (Android 8.1+)
          - **Target SDK**: 35 (Android 14)
          - **Architecture**: MVVM with Room Database
          - **UI**: Material Design 3
          
          ### ğŸš€ What's New:
          - Initial release with core shopping functionality
          - Complete authentication system
          - Product catalog with sample data
          - Responsive UI design
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v3
      with:
        name: release-apk-${{ github.ref_name }}
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30 